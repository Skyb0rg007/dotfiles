#!/usr/bin/bash

stowdir=/usr/local/stow

curlopts=(
    --silent
    -H "Accept: application/json"
    -H "X-GitHub-Api-Version: 2022-11-28"
)

apiurl=https://api.github.com/repos

commands=(
    autoconf
    chezscheme
    cmake
    koka
    llvm
    luarocks
    mercury
    mlkit
    smlnj
    swipl
)

# Generic method of extracting the version number from query output
clean-version () {
    sed -e 's/^[^0-9]\+//' -e 's/[_]/./g' -e 's:/::g'
}

# Print the current version on apt-get
find-apt-version () {
    declare name="$1"
    printf 'Latest apt package version:\n%s ' "$name"
    apt show "$name" 2>/dev/null | grep --max-count=1 Version | clean-version
}

# Name to use for listing stowed packages
find-with () {
    declare name="$1"
    echo "Available in stow directory:"
    find "$stowdir" \
        -maxdepth 1 \
        -iname "$name*" \
        -exec basename {} \;
}

# Print the tag name of the latest GitHub release
query-release-tagname () {
    declare name="$1" repo="$2"
    printf 'Latest GitHub release:\n%s ' "$name"
    curl "${curlopts[@]}" "$apiurl/$repo/releases/latest" \
        | jq --raw-output '.tag_name // error("missing tag name")' \
        | clean-version
}

# Print the name of the most recently created Git tag on the repo
query-latest-tagname () {
    declare name="$1" repo="$2"
    printf 'Latest GitHub release:\n%s ' "$name"
    curl "${curlopts[@]}" "$apiurl/$repo/tags" \
        | jq --raw-output '.[0].name' \
        | clean-version
}

# Print the contents of a given file from the master branch
query-file-content () {
    declare name="$1" repo="$2" file="$3"
    printf 'Latest GitHub release:\n%s ' "$name"
    curl "${curlopts[@]}" "$apiurl/$repo/contents/$file" \
        | jq --raw-output '.content // error("missing file")' \
        | base64 --decode \
        | clean-version
}

# Print the version suffix of the toplevel directory name
query-ftp () {
    declare name="$1" url="$2"
    printf 'Latest FTP release:\n%s ' "$name"
    curl --silent "$url" \
        | tar -ztO 2>&1 \
        | head --lines=1 \
        | clean-version
}

usage () {
    echo "latest-release <command>"
    echo "available commands:"
    for cmd in "${commands[@]}"; do
        echo "    $cmd"
    done
}

if [[ $# -ne 1 ]]; then
    echo >&2 "Invalid number of arguments"
    usage
    exit 1
fi

case "${1,,}" in
    -h|--help)
        usage
        ;;
    --completion)
        echo "complete -W '${commands[*]}' latest-release"
        ;;
    mlkit)
        find-with mlkit
        query-release-tagname mlkit melsman/mlkit
        ;;
    llvm)
        find-with llvm
        query-release-tagname llvm llvm/llvm-project
        ;;
    cmake)
        find-apt-version cmake
        find-with cmake
        query-release-tagname cmake KitWare/CMake
        ;;
    chezscheme)
        find-with chezscheme
        query-release-tagname chezscheme cisco/ChezScheme
        ;;
    koka)
        find-with koka
        query-release-tagname koka koka-lang/koka
        ;;
    mercury)
        find-with mercury
        query-latest-tagname mercury Mercury-Language/mercury
        ;;
    smlnj)
        find-apt-version smlnj
        find-with smlnj
        query-file-content smlnj smlnj/legacy config/version
        ;;
    luarocks)
        find-apt-version luarocks
        find-with luarocks
        query-latest-tagname luarocks luarocks/luarocks
        ;;
    swipl)
        find-apt-version swi-prolog
        find-with swipl
        query-file-content swipl SWI-Prolog/swipl-devel VERSION
        ;;
    autoconf)
        find-apt-version autoconf
        find-with autoconf
        query-ftp autoconf https://ftp.gnu.org/gnu/autoconf/autoconf-latest.tar.gz
        ;;
    *)
        echo >&2 "Invalid argument $1"
        usage
        exit 1
        ;;
esac
